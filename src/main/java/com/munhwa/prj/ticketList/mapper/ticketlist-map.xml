<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.munhwa.prj.ticketList.mapper.TicketListMapper">
	<resultMap type="com.munhwa.prj.ticketList.vo.TicketListVO"
		id="ticketListResultMap">
		<id property="id" column="id" />
		<result property="performanceId" column="performance_id" />
		<result property="memberId" column="member_id" />
		<result property="qrcode" column="qrcode" />
		<result property="attendance" column="attendance" />
		<collection property="performancevo"
			resultMap="performanceResultMap"></collection>
	</resultMap>

	<resultMap type="com.munhwa.prj.performance.vo.PerformanceVO"
		id="performanceResultMap">
		<id property="id" column="id" />
		<result property="name" column="name" />
		<result property="location" column="location" />
		<result property="sdate" column="sdate" />
		<result property="edate" column="edate" />
		<result property="content" column="content" />
		<result property="status" column="status" />
		<result property="image" column="image" />
		<result property="artistId" column="artist_id" />
		<result property="price" column="price" />
		<result property="person" column="person" />
	</resultMap>
	
	<select id="ticketListSelectList"
		parameterType="com.munhwa.prj.ticketList.vo.TicketListVO"
		resultMap="ticketListResultMap">

		SELECT T.ID,
		P.NAME,
		P.SDATE,
		P.EDATE,
		P.LOCATION
		FROM TICKET_LIST T,
		MEMBER M,
		PERFORMANCE P
		WHERE T.MEMBER_ID = #{memberId}
		AND T.PERFORMANCE_ID = P.ID
		ORDER BY SDATE DESC
	</select>

	<select id="ticketListSelect"
		parameterType="com.munhwa.prj.ticketList.vo.TicketListVO"
		resultMap="ticketListResultMap">
		SELECT M.NICKNAME,
		P.NAME,
		P.SDATE,
		P.EDATE,
		P.LOCATION,
		P.IMAGE,
		T.QRCODE,
		CC.NAME as ATTENDANCE
		FROM TICKET_LIST T,
		MEMBER M,
		PERFORMANCE P,
		COMMON_CODE CC
		WHERE T.ID = #{id}
		AND T.ATTENDANCE = CC.ID
		AND T.MEMBER_ID = M.ID
		AND T.PERFORMANCE_ID = P.ID
	</select>

	<select id="ticketListInsert" statementType="CALLABLE" parameterType="map" resultType="hashmap">
	<![CDATA[
        call TICKET (
                #{v_member_id, mode=IN, jdbcType=VARCHAR, javaType=string},
                #{v_performance_id, mode=IN, jdbcType=INTEGER, javaType=int},
                #{v_ticket_id, mode=OUT, jdbcType=INTEGER, javaType=int}
            )
     ]]>
	</select>
	
	<update id="qrcodeUpdate" parameterType="com.munhwa.prj.ticketList.vo.TicketListVO">
		UPDATE TICKET_LIST
		SET QRCODE = #{qrcode}
		WHERE ID = #{id}
	</update>
	
	<update id="qrcodeAttendance" parameterType="com.munhwa.prj.ticketList.vo.TicketListVO" >
		UPDATE TICKET_LIST
		SET ATTENDANCE = '참석'
		WHERE ID = #{id}
	</update>
	
</mapper>